#
# The build and pack template used by the CI publish and PR validation scripts.
# The template sets the version number, builds all binaries, and then packs them as NuGet packages.
#

parameters:
  # MustPublish is `true` for CI builds and `false` for PR validation.
- name: MustPublish
  type: boolean
  default: false

  # Matrix with target platforms for Hermes binaries.
- name: BuildMatrix
  type: object
  default:
  - Name: uwp_x64
    TargetCPU: x64
    BuildAppPlatform: uwp
  - Name: uwp_x86
    TargetCPU: x86
    BuildAppPlatform: uwp
  - Name: uwp_arm64
    TargetCPU: arm64
    BuildAppPlatform: uwp
  - Name: win32_x64
    TargetCPU: x64
    BuildAppPlatform: win32
  - Name: win32_x86
    TargetCPU: x86
    BuildAppPlatform: win32
  - Name: win32_arm64
    TargetCPU: arm64
    BuildAppPlatform: win32
    # ARM64 "Emulation Compatible" is to run ARM64 Hermes DLL in a x64 app
    # on Windows ARM64 in emulation mode.
    # See: https://learn.microsoft.com/en-us/windows/arm/arm64ec
  - Name: win32_arm64ec 
    TargetCPU: arm64ec
    BuildAppPlatform: win32

resources:
  repositories:
    # The repo for the Office compliant build pipeline templates.
  - repository: OfficePipelineTemplates
    type: git
    name: 1ESPipelineTemplates/OfficePipelineTemplates
    ref: refs/tags/release

extends:
  # Extend the Office compliant build pipeline template.
  template: v1/Office.Official.PipelineTemplate.yml@OfficePipelineTemplates
  parameters:
    pool:
      name: Azure-Pipelines-1ESPT-ExDShared
      image: windows-latest
      os: windows
    sdl:
      binskim:
        analyzeTarget: |
          $(Build.StagingDirectory)\build\**\*.dll
          $(Build.StagingDirectory)\build\**\*.exe
      componentgovernance:
        ignoreDirectories: $(Build.SourcesDirectory)\website
      eslint:
        enableExclusions: true
        # This repo does not ship any JavaScript code. But it has many test cases for
        # the Hermes JS engine that fail parsing, have code considered insecure and crash eslint.
        exclusionPatterns: |
          '**/*.*'
      suppression:
        suppressionFile: $(Build.SourcesDirectory)\.ado\guardian\SDL\.gdnsuppress
      codeql:
        compiled:
          enabled: true
        runSourceLanguagesInSourceAnalysis: true

    stages:
    - stage: main
      jobs:

        #=============================================================================
        # Set version number
        #=============================================================================
      - job: Set_Version_Number
        displayName: Set Version Number

        variables:
          # Component Governance is ran as part of the Build Job.
        - name: skipComponentGovernanceDetection
          value: true
          # Convert MustPublish parameter to a variable to access in script
        - name: mustPublish
          value: ${{ parameters.MustPublish }}

        steps:
        - script: node .ado\scripts\setVersionNumber.js
          displayName: Compute version numbers
