parameters:
- name: isPublish
  type: boolean
  default : false

# Matrix with target platforms.
- name: BuildMatrix
  type: object
  default:
  - Name: uwp_x64
    TargetCPU: x64
    BuildAppPlatform: uwp
  - Name: uwp_x86
    TargetCPU: x86
    BuildAppPlatform: uwp
  - Name: uwp_arm64
    TargetCPU: arm64
    BuildAppPlatform: uwp
  - Name: win32_x64
    TargetCPU: x64
    BuildAppPlatform: win32
  - Name: win32_x86
    TargetCPU: x86
    BuildAppPlatform: win32
  - Name: win32_arm64
    TargetCPU: arm64
    BuildAppPlatform: win32
  - Name: win32_arm64ec
    TargetCPU: arm64ec
    BuildAppPlatform: win32

resources:
  repositories:
  - repository: OfficePipelineTemplates
    type: git
    name: 1ESPipelineTemplates/OfficePipelineTemplates
    ref: refs/tags/release

variables:
- name: tags
  value: production,externalfacing
- name: Is_Publish_Build
  value: ${{ parameters.isPublish }}

extends:
  template: v1/Office.Official.PipelineTemplate.yml@OfficePipelineTemplates
  parameters:
    pool:
      name: Azure-Pipelines-1ESPT-ExDShared
      image: windows-latest
      os: windows
    sdl:
      binskim:
        analyzeTarget: $(Build.ArtifactStagingDirectory)/**/*.dll
      componentgovernance:
        ignoreDirectories: $(Build.SourcesDirectory)/website
      eslint:
        enableExclusions: true
        # This repo does not ship any javascript code. But has many test cases for the js engine that fail parsing, have code considered insecure and crash eslint.
        exclusionPatterns: |
          '**/*.*'
      suppression:
        suppressionFile: $(Build.SourcesDirectory)\.ado\guardian\SDL\.gdnsuppress
      codeql:
        compiled:
          enabled: true
        runSourceLanguagesInSourceAnalysis: true

    stages:
    - stage: main
      jobs:
      - job: Setup
        variables:
          # Component Governance is ran as part of the Build Job.
          - name: "skipComponentGovernanceDetection"
            value: "true"
        steps:
          - script: node .ado\scripts\setVersionNumber.js
            name: setVersions
            displayName: Compute version numbers
          - task: PowerShell@2
            displayName: Show hermes publish vars
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "hermes_publish: ${{ parameters.isPublish }}"
                Write-Host "Is_Publish_Build: ${env:IS_PUBLISH_BUILD}"
